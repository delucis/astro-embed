---
export interface Props {
	/**
	 * Gist url to fetch
	 */
	id: string;
	/**
	 * Optional file name to fetch, case sensitive
	 */
	fileName?: string;
}
const { id, fileName } = Astro.props;
let url = id + '.json';
if (fileName) {
	url += `?file=${fileName}`;
}

async function fetchGist(id: string): Promise<
	| {
			description: string;
			created_at: Date;
			files: string[];
			owner: string;
			stylesheet: string;
			div: string;
	  }
	| undefined
> {
	try {
		const gistUrl = new URL(url);
		return await fetch(gistUrl).then((res) => res.json());
	} catch (e: any) {
		console.error(
			`[error]  astro-embed
         ${e.status} - ${e.statusText}: Failed to fetch gist ${id}`
		);
		return;
	}
}
const gist = await fetchGist(id);

// TODO use stylesheet
const stylesheetUrl = gist?.stylesheet;
---

{
	gist && (
		<astro-embed-gist data-cssurl={stylesheetUrl}>
			<p class="gist-embed-description">{gist.description}</p>
			<Fragment set:html={gist.div} />
			<span class="gist-embed-owner">gist by {gist.owner}</span>
		</astro-embed-gist>
	)
}
<style>
	astro-embed-gist {
		display: block;
	}
	.gist-embed-owner {
	}
	.gist-embed-description {
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', function () {
		const gists = document.querySelectorAll<HTMLElement>('astro-embed-gist');
		gists.forEach((e) => {
			const stylesheetUrl = e.dataset.cssurl;
			if (!stylesheetUrl) return;
			const linkElement = document.createElement('link');
			linkElement.href = stylesheetUrl;
			linkElement.rel = 'stylesheet';
			linkElement.type = 'text/css';
			document.head.appendChild(linkElement);
		});
	});
</script>
