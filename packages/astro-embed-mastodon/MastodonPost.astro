---
import Attachments from './Attachments.astro';
import PostFooter from './PostFooter.astro';
import PostHeader from './PostHeader.astro';
import QuotedPost from './QuotedPost.astro';
import { fetchMastodonPost, replaceEmojis } from './utils';
import styleUrl from './GlobalStyles.css?url';

export interface Props {
	id: string;
}
const { id } = Astro.props;

const post = await fetchMastodonPost(id);
---

{
	post && (
		<astro-embed-mastodon>
			<template shadowrootmode="open">
				<link rel="stylesheet" href={styleUrl} />
				<blockquote part="root">
					<PostHeader {post} />
					<div
						part="content"
						dir={post.dir}
						lang={post.language}
						set:html={replaceEmojis(post.content, post.emojis)}
					/>
					<Attachments {post} />
					{post.quote && <QuotedPost parent={post} quote={post.quote} />}
					<PostFooter {post} />
				</blockquote>
			</template>
		</astro-embed-mastodon>
	)
}
<style>
	:global(:root) {
		/* Light colour palette */
		--mc-color-scheme--light: light;
		--mc-color--light: #292938;
		--mc-color-primary--light: #000;
		--mc-color-secondary--light: #45455f;
		--mc-color-link--light: #5653ed;
		--mc-background-color--light: #fff;
		--mc-border-color--light: #cfd9de;
		--mc-background-color-surface--light: #e8e6f0;
		--mc-background-color-accent--light: #c6bfd9;
		/* --mc-border-color-media--light: rgba(252, 248, 255, .15) */

		/* Dark colour palette */
		--mc-color-scheme--dark: dark;
		--mc-color--dark: #f0f1ff;
		--mc-color-primary--dark: #f0f1ff;
		--mc-color-secondary--dark: #8b8dac;
		--mc-color-link--dark: #8886ff;
		--mc-background-color--dark: #181821;
		--mc-border-color--dark: #c8cdfe2e;
		--mc-background-color-surface--dark: #6247e61a;
		--mc-background-color-accent--dark: #c8cdfe14;
		/* --mc-border-color-media--dark: rgba(252, 248, 255, .15) */

		--mc-color-scheme: var(--mc-color-scheme--light);
		--mc-color: var(--mc-color--light);
		--mc-color-primary: var(--mc-color-primary--light);
		--mc-color-secondary: var(--mc-color-secondary--light);
		--mc-color-link: var(--mc-color-link--light);
		--mc-background-color: var(--mc-background-color--light);
		--mc-border-color: var(--mc-border-color--light);
		--mc-background-color-surface: var(--mc-background-color-surface--light);
		--mc-background-color-accent: var(--mc-background-color-accent--light);

		--mc-padding: 1em;
		--mc-border-radius: 0.5em;
		--mc-font-family:
			system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
			Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
	}

	@media (prefers-color-scheme: dark) {
		:global(:root) {
			--mc-color-scheme: var(--mc-color-scheme--dark);
			--mc-color: var(--mc-color--dark);
			--mc-color-primary: var(--mc-color-primary--dark);
			--mc-color-secondary: var(--mc-color-secondary--dark);
			--mc-color-link: var(--mc-color-link--dark);
			--mc-background-color: var(--mc-background-color--dark);
			--mc-border-color: var(--mc-border-color--dark);
			--mc-background-color-surface: var(--mc-background-color-surface--dark);
			--mc-background-color-accent: var(--mc-background-color-accent--dark);
		}
	}

	/* Dynamic colours when supported */
	@supports (--color: light-dark(var(--a), var(--b))) {
		:global(:root) {
			--mc-color-scheme: inherit;
			--mc-color: light-dark(var(--mc-color--light), var(--mc-color--dark));
			--mc-color-primary: light-dark(
				var(--mc-color-primary--light),
				var(--mc-color-primary--dark)
			);
			--mc-color-secondary: light-dark(
				var(--mc-color-secondary--light),
				var(--mc-color-secondary--dark)
			);
			--mc-color-link: light-dark(
				var(--mc-color-link--light),
				var(--mc-color-link--dark)
			);
			--mc-background-color: light-dark(
				var(--mc-background-color--light),
				var(--mc-background-color--dark)
			);
			--mc-border-color: light-dark(
				var(--mc-border-color--light),
				var(--mc-border-color--dark)
			);
			--mc-background-color-surface: light-dark(
				var(--mc-background-color-surface--light),
				var(--mc-background-color-surface--dark)
			);
			--mc-background-color-accent: light-dark(
				var(--mc-background-color-accent--light),
				var(--mc-background-color-accent--dark)
			);
		}
	}

	astro-embed-mastodon::part(root) {
		margin: 0;
		border: 1px solid var(--mc-border-color, #cfd9de);
		border-radius: var(--mc-border-radius);

		display: flex;
		flex-direction: column;
		gap: 1em;

		overflow-wrap: anywhere;
		padding: var(--mc-padding, 1em);
		font-family: var(--mc-font-family, inherit);
		color-scheme: var(--mc-color-scheme);
		color: var(--mc-color);
		background-color: var(--mc-background-color);
	}

	astro-embed-mastodon::part(content) {
		display: flex;
		flex-direction: column;
		gap: 1.16em;

		font-size: 1.1875em;
		line-height: 1.25;

		overflow-wrap: break-word;
		overflow: hidden;
		text-overflow: ellipsis;

		color: var(--mc-color-primary);
	}
</style>
